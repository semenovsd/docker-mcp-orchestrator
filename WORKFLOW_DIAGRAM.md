# Визуальная диаграмма нового workflow

## 🎯 Общая схема системы

```
┌─────────────────────────────────────────────────────────────────┐
│                    Docker MCP Toolkit                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ context7 │  │playwright│  │  redis   │  │  github  │  ...  │
│  │ (disabled)│ │ (disabled)│ │ (disabled)│ │ (disabled)│        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
│                                                                  │
│  Все MCP серверы установлены и доступны                          │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ docker mcp CLI
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              Docker MCP Orchestrator                              │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  ServerDiscovery                                          │  │
│  │  • docker mcp server ls                                  │  │
│  │  • docker mcp server inspect <name>                      │  │
│  │  • docker mcp tools list --server <name>                 │  │
│  │  → Обнаруживает все серверы автоматически                 │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            │                                     │
│                            ▼                                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  ServerRegistry                                           │  │
│  │  • Кэширует метаданные (без tools)                        │  │
│  │  • Периодическая синхронизация (каждые 5 мин)             │  │
│  │  • Применяет переопределения из config/servers.json       │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            │                                     │
│                            ▼                                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  MCP Tools (8 инструментов)                               │  │
│  │  • list_available_servers()  ← Краткий каталог           │  │
│  │  • server_info(name)          ← Детали сервера           │  │
│  │  • activate_server(name)      ← Активация + tools        │  │
│  │  • discover_servers()          ← Ручное обновление       │  │
│  │  • deactivate_server(name)    ← Деактивация              │  │
│  │  • activate_for_task(desc)     ← Умный выбор             │  │
│  │  • get_active_servers()        ← Активные серверы        │  │
│  │  • sync_state()                ← Синхронизация           │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ MCP Protocol (stdio)
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    AI (Claude/Cursor)                           │
│                                                                  │
│  При старте получает:                                           │
│  • 8 инструментов orchestrator                                 │
│  • ~500 токенов (минимум!)                                      │
└─────────────────────────────────────────────────────────────────┘
```

## 📊 Workflow: От старта до работы

### Этап 1: Инициализация (автоматически)

```
┌─────────────────────────────────────────────────────────┐
│  Orchestrator стартует                                   │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  1. ServerDiscovery.discover_all_servers()              │
│     ┌──────────────────────────────────────┐           │
│     │ docker mcp server ls                 │           │
│     │ → context7, playwright, redis, ...   │           │
│     └──────────────────────────────────────┘           │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  2. Для каждого сервера:                                │
│     ┌──────────────────────────────────────┐           │
│     │ docker mcp server inspect <name>    │           │
│     │ → description, config, auth           │           │
│     └──────────────────────────────────────┘           │
│     ┌──────────────────────────────────────┐           │
│     │ docker mcp tools list --server <name>│           │
│     │ → количество tools (БЕЗ деталей!)    │           │
│     └──────────────────────────────────────┘           │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  3. ServerRegistry кэширует метаданные:                 │
│     {                                                    │
│       "redis": ServerMetadata(                          │
│         name="redis",                                    │
│         category="database",                            │
│         tool_count=15,                                   │
│         status="disabled"                                │
│       ),                                                 │
│       "context7": ServerMetadata(...),                  │
│       ...                                                │
│     }                                                    │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  ✅ Готов к работе!                                      │
│  Реестр содержит метаданные всех серверов               │
│  (БЕЗ tools - минимум токенов!)                         │
└─────────────────────────────────────────────────────────┘
```

### Этап 2: AI получает каталог

```
┌─────────────────────────────────────────────────────────┐
│  AI вызывает: list_available_servers()                   │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  Orchestrator формирует КРАТКИЙ каталог:                 │
│                                                          │
│  📦 Available MCP Servers (12)                          │
│                                                          │
│  🗄️ Database (2)                                        │
│    • redis (⚪) - Redis cache                            │
│      ~15 tools                                           │
│    • postgres (⚪) - PostgreSQL                          │
│      ~1 tool                                             │
│                                                          │
│  🌐 Browser (1)                                          │
│    • playwright (⚪) - Web automation                    │
│      ~15 tools                                           │
│                                                          │
│  📚 Documentation (1)                                    │
│    • context7 (⚪) - Library docs                        │
│      ~2 tools                                            │
│                                                          │
│  ... (только метаданные, БЕЗ деталей tools!)            │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  AI получает:                                             │
│  • ~200-500 токенов (вместо 15-20k!)                    │
│  • Полный список доступных серверов                      │
│  • Может выбрать нужные                                  │
└─────────────────────────────────────────────────────────┘
```

### Этап 3: AI активирует нужные серверы

```
┌─────────────────────────────────────────────────────────┐
│  Пользователь: "Настрой Redis кэш"                      │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  AI анализирует:                                          │
│  • Нужен Redis → activate_server("redis")               │
│  • Для документации → activate_server("context7")        │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  AI вызывает: activate_server("redis")                  │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  Orchestrator:                                            │
│  1. docker mcp server enable redis                      │
│  2. docker mcp tools list --server redis                │
│  3. Получает ВСЕ tools redis (с деталями)               │
│  4. Кэширует tools в state.server_tools_cache           │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  Orchestrator проверяет зависимости:                     │
│  • redis требует context7 для документации?              │
│  • Да → автоматически активирует context7               │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  AI получает ответ:                                       │
│  ┌──────────────────────────────────────┐               │
│  │ ✅ redis activated                    │               │
│  │ ✅ context7 auto-activated           │               │
│  │                                       │               │
│  │ Available tools (15):                 │               │
│  │ • redis_get(key)                     │               │
│  │ • redis_set(key, value)              │               │
│  │ • redis_del(key)                     │               │
│  │ • redis_keys(pattern)                │               │
│  │ • redis_hget(hash, field)            │               │
│  │ • redis_hset(hash, field, value)     │               │
│  │ • redis_lpush(list, value)           │               │
│  │ • redis_rpush(list, value)           │               │
│  │ • redis_lrange(list, start, end)     │               │
│  │ • redis_config_get(parameter)         │               │
│  │ • redis_config_set(parameter, value) │               │
│  │ • redis_info(section)                │               │
│  │ • redis_ping()                       │               │
│  │ • redis_ttl(key)                     │               │
│  │ • redis_expire(key, seconds)        │               │
│  │                                       │               │
│  │ Context7 tools (2):                   │               │
│  │ • resolve-library-id("redis")        │               │
│  │ • get-library-docs(library_id, ...)   │               │
│  └──────────────────────────────────────┘               │
│                                                          │
│  ~2000-3000 токенов (только для активированных!)       │
└─────────────────────────────────────────────────────────┘
```

### Этап 4: AI использует tools

```
┌─────────────────────────────────────────────────────────┐
│  AI теперь может использовать:                           │
│                                                          │
│  1. Context7 для документации:                          │
│     → resolve-library-id("redis")                       │
│     → get-library-docs(redis_id, query="cache setup")  │
│                                                          │
│  2. Redis tools для работы:                             │
│     → redis_set("session:user123", "data")              │
│     → redis_config_set("maxmemory", "256mb")            │
│     → redis_get("session:user123")                       │
└─────────────────────────────────────────────────────────┘
```

## 📈 Сравнение токенов

### Старая схема (текущая)

```
┌─────────────────────────────────────────────────────────┐
│  При старте:                                             │
│  • 8 инструментов orchestrator: ~500 токенов           │
│                                                          │
│  Если AI вызывает list_available_servers():              │
│  • Хардкод список: ~300 токенов                         │
│                                                          │
│  Если все серверы активны:                              │
│  • Все tools всех серверов: 15,000-20,000 токенов      │
│                                                          │
│  ИТОГО: до 20,000+ токенов                             │
└─────────────────────────────────────────────────────────┘
```

### Новая схема (предлагаемая)

```
┌─────────────────────────────────────────────────────────┐
│  При старте:                                             │
│  • 8 инструментов orchestrator: ~500 токенов           │
│                                                          │
│  AI вызывает list_available_servers():                  │
│  • Краткий каталог (метаданные): ~300 токенов          │
│                                                          │
│  AI активирует нужные серверы:                          │
│  • Redis tools: ~1,500 токенов                          │
│  • Context7 tools: ~500 токенов                          │
│                                                          │
│  ИТОГО: ~2,800 токенов (вместо 20,000!)                │
│  ЭКОНОМИЯ: 86%!                                          │
└─────────────────────────────────────────────────────────┘
```

## 🔄 Периодическая синхронизация

```
┌─────────────────────────────────────────────────────────┐
│  Фоновая задача (каждые 5 минут):                       │
│                                                          │
│  1. Проверка: нужно ли обновление?                     │
│     • Прошло >5 минут с последнего обновления?          │
│     • Да → продолжаем                                   │
│                                                          │
│  2. Обнаружение:                                        │
│     • docker mcp server ls                              │
│     • Сравнение с кэшем                                 │
│     • Обнаружение новых серверов                        │
│                                                          │
│  3. Обновление метаданных:                              │
│     • Для новых серверов: полное обнаружение            │
│     • Для существующих: проверка изменений              │
│                                                          │
│  4. Обновление кэша:                                    │
│     • Обновление ServerRegistry                         │
│     • Обновление last_discovery                         │
└─────────────────────────────────────────────────────────┘
```

## 🎯 Ключевые преимущества

```
┌─────────────────────────────────────────────────────────┐
│  ✅ Автоматическое обнаружение                           │
│     • Не нужно обновлять код при добавлении сервера     │
│     • Всегда актуальный список                           │
│                                                          │
│  ✅ Минимум токенов                                      │
│     • При старте: только метаданные                      │
│     • Tools только для активированных                    │
│                                                          │
│  ✅ Гибкость для AI                                      │
│     • AI видит все доступные серверы                    │
│     • AI сам выбирает что активировать                   │
│                                                          │
│  ✅ Умные рекомендации                                   │
│     • activate_for_task() работает с любыми серверами     │
│     • Автоматическая активация зависимостей              │
└─────────────────────────────────────────────────────────┘
```

## 🔧 Технические детали

### Обнаружение серверов

```
docker mcp server ls
→ Парсинг вывода
→ Список названий серверов

Для каждого сервера:
  docker mcp server inspect <name>
  → JSON с метаданными
  → Парсинг description, config, auth

  docker mcp tools list --server <name>
  → Подсчет количества tools
  → БЕЗ деталей (минимум токенов!)
```

### Кэширование

```
ServerRegistry:
  • servers: dict[str, ServerMetadata]  # В памяти
  • last_discovery: datetime
  • discovery_interval: 5 minutes
  
При запросе:
  • Проверка: прошло ли >5 минут?
  • Если да → обновление
  • Если нет → использование кэша
```

### Активация сервера

```
activate_server("redis"):
  1. docker mcp server enable redis
  2. docker mcp tools list --server redis
  3. Получение ВСЕХ tools (с деталями)
  4. Кэширование в state.server_tools_cache
  5. Проверка зависимостей
  6. Автоматическая активация context7 (если нужно)
  7. Возврат списка tools AI
```

---

## ✅ Итоговая схема

```
Docker MCP Toolkit (все серверы)
        │
        ▼ (автоматическое обнаружение)
Docker MCP Orchestrator
  • Обнаруживает все серверы
  • Кэширует метаданные (без tools)
  • Предоставляет краткий каталог
        │
        ▼ (MCP protocol)
AI получает:
  • 8 инструментов orchestrator (~500 токенов)
  • Краткий каталог серверов (~300 токенов)
  ИТОГО: ~800 токенов (вместо 15-20k!)
        │
        ▼ (AI выбирает и активирует)
AI активирует нужные серверы:
  • activate_server("redis")
  • activate_server("context7")
        │
        ▼
AI получает tools только активированных:
  • Redis tools (~1500 токенов)
  • Context7 tools (~500 токенов)
  ИТОГО: ~2000 токенов (вместо 15-20k!)
        │
        ▼
AI использует tools для работы
```

**Экономия токенов: 90%+ при старте, 85%+ при работе!**
